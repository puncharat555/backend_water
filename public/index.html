<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Water Level Monitoring</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1 class="title">Water Level Monitoring</h1>

  <div class="container">
    <!-- Node 1 -->
    <div class="node-box">
      <h2>üì° Node 1</h2>
      <p id="waterLevelNode1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: -</p>
      <p id="rssiNode1">RSSI: -</p>
      <p id="voltageNode1">‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: -</p>
      <p id="currentNode1">‡∏Å‡∏£‡∏∞‡πÅ‡∏™: -</p>
      <p id="timeNode1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: -</p>
    </div>

    <!-- Node 2 -->
    <div class="node-box">
      <h2>üîÅ Node 2</h2>
      <p id="rssiNode2">RSSI: -</p>
      <p id="voltageNode2">‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: -</p>
      <p id="currentNode2">‡∏Å‡∏£‡∏∞‡πÅ‡∏™: -</p>
      <p id="timeNode2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: -</p>
    </div>
  </div>

  <div class="table-wrapper">
    <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
    <table id="dataTable">
      <thead>
        <tr>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (cm)</th>
          <th>RSSI Node1</th>
          <th>RSSI Node2</th>
          <th>V Node1</th>
          <th>I Node1</th>
          <th>V Node2</th>
          <th>I Node2</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î Node1</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î Node2</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const fixedDepth = 120;

    async function loadData() {
      try {
        const res = await fetch('https://backend-water-rf88.onrender.com/distance');
        const data = await res.json();

        console.log('Data from API:', data);

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        data.forEach(item => {
          const level = (fixedDepth - item.distance).toFixed(1);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.distance > 0 ? level : '-'}</td>
            <td>${item.rssi_node1 ?? '-'}</td>
            <td>${item.rssi_node2 ?? '-'}</td>
            <td>${item.v_node1 ?? '-'}</td>
            <td>${item.i_node1 ?? '-'}</td>
            <td>${item.v_node2 ?? '-'}</td>
            <td>${item.i_node2 ?? '-'}</td>
            <td>${item.time_node1 ?? '-'}</td>
            <td>${item.time_node2 ?? '-'}</td>
          `;
          tbody.appendChild(tr);
        });

        // ‡∏´‡∏≤ latest ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Node ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ô
        const latestNode1 = [...data].reverse().find(item => item.distance > 0);
        const latestNode2 = [...data].reverse().find(item =>
          item.rssi_node2 !== undefined || item.v_node2 !== undefined || item.i_node2 !== undefined
        );

        console.log('Latest Node1:', latestNode1);
        console.log('Latest Node2:', latestNode2);

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏•‡πà‡∏≠‡∏á Node 1
        if (latestNode1) {
          const level = (fixedDepth - latestNode1.distance).toFixed(1);
          const waterLevelEl = document.getElementById('waterLevelNode1');
          if (waterLevelEl) waterLevelEl.innerText = `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: ${level} cm`;

          const rssiNode1El = document.getElementById('rssiNode1');
          if (rssiNode1El) rssiNode1El.innerText = `RSSI: ${latestNode1.rssi_node1 ?? '-'}`;

          const voltageNode1El = document.getElementById('voltageNode1');
          if (voltageNode1El) voltageNode1El.innerText = `‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: ${latestNode1.v_node1 ?? '-'}`;

          const currentNode1El = document.getElementById('currentNode1');
          if (currentNode1El) currentNode1El.innerText = `‡∏Å‡∏£‡∏∞‡πÅ‡∏™: ${latestNode1.i_node1 ?? '-'}`;

          const timeNode1El = document.getElementById('timeNode1');
          if (timeNode1El) timeNode1El.innerText = `‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: ${latestNode1.time_node1 ?? '-'}`;
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏•‡πà‡∏≠‡∏á Node 2
        if (latestNode2) {
          const rssiNode2El = document.getElementById('rssiNode2');
          if (rssiNode2El) rssiNode2El.innerText = `RSSI: ${latestNode2.rssi_node2 ?? '-'}`;

          const voltageNode2El = document.getElementById('voltageNode2');
          if (voltageNode2El) voltageNode2El.innerText = `‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: ${latestNode2.v_node2 ?? '-'}`;

          const currentNode2El = document.getElementById('currentNode2');
          if (currentNode2El) currentNode2El.innerText = `‡∏Å‡∏£‡∏∞‡πÅ‡∏™: ${latestNode2.i_node2 ?? '-'}`;

          const timeNode2El = document.getElementById('timeNode2');
          if (timeNode2El) timeNode2El.innerText = `‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: ${latestNode2.time_node2 ?? '-'}`;
        }

      } catch (error) {
        console.error('Load data error:', error);

        // ‡∏ñ‡πâ‡∏≤ error ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á
        ['waterLevelNode1', 'rssiNode1', 'voltageNode1', 'currentNode1', 'timeNode1',
         'rssiNode2', 'voltageNode2', 'currentNode2', 'timeNode2'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.innerText = '-';
        });

        // ‡πÅ‡∏à‡πâ‡∏á error ‡∏ó‡∏µ‡πà Node 1 ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏£‡∏Å
        const waterLevelEl = document.getElementById('waterLevelNode1');
        if (waterLevelEl) waterLevelEl.innerText = '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
      }
    }

    loadData();
    setInterval(loadData, 5000);
  </script>
</body>
</html>
