<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Water Level Monitoring</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Chart.js ‡πÅ‡∏•‡∏∞ Zoom plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
</head>
<body>
  <h1 class="title">Water Level Monitoring</h1>

  <div class="water-level-display">
    <div class="water-depth">
      <p id="waterLevelNode1" class="main-water-level">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: -</p>
    </div>
  </div>

  <div class="container">
    <!-- Node 1 -->
    <div class="node-box">
      <h2>Node 1</h2>
      <p id="rssiNode1">RSSI: -</p>
      <p id="voltageNode1">‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: -</p>
      <p id="currentNode1">‡∏Å‡∏£‡∏∞‡πÅ‡∏™: -</p>
      <p id="timeNode1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: -</p>

      <div class="chart-wrapper">
        <canvas id="waterLevelChart"></canvas>
      </div>
      <div class="chart-wrapper">
        <canvas id="currentNode1Chart"></canvas>
      </div>
    </div>

    <!-- Node 2 -->
    <div class="node-box">
      <h2>Node 2</h2>
      <p id="rssiNode2">RSSI: -</p>
      <p id="voltageNode2">‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: -</p>
      <p id="currentNode2">‡∏Å‡∏£‡∏∞‡πÅ‡∏™: -</p>
      <p id="timeNode2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: -</p>

      <div class="chart-wrapper">
        <canvas id="currentNode2Chart"></canvas>
      </div>
    </div>
  </div>

  <div class="table-wrapper">
    <h3>üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
    <table id="dataTable">
      <thead>
        <tr>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏î‡∏¥‡∏ö (cm)</th>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (cm)</th>
          <th>RSSI Node1</th>
          <th>RSSI Node2</th>
          <th>V Node1</th>
          <th>I Node1</th>
          <th>V Node2</th>
          <th>I Node2</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î Node1</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î Node2</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const fixedDepth = 120;

    const waterLevelCtx = document.getElementById('waterLevelChart').getContext('2d');
    const currentNode1Ctx = document.getElementById('currentNode1Chart').getContext('2d');
    const currentNode2Ctx = document.getElementById('currentNode2Chart').getContext('2d');

    const labels = [];
    const waterLevelData = [];
    const currentNode1Data = [];
    const currentNode2Data = [];

    const commonOptions = {
      responsive: true,
      plugins: {
        legend: { display: true },
        zoom: {
          pan: { enabled: true, mode: 'x' },
          zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
        }
      },
      scales: {
        x: { display: true },
        y: { display: true }
      }
    };

    const waterLevelChart = new Chart(waterLevelCtx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (cm)',
          data: waterLevelData,
          borderColor: '#007bff',
          backgroundColor: 'rgba(0,123,255,0.1)',
          fill: true,
          tension: 0.3
        }]
      },
      options: commonOptions
    });

    const currentNode1Chart = new Chart(currentNode1Ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: '‡∏Å‡∏£‡∏∞‡πÅ‡∏™ Node 1 (mA)',
          data: currentNode1Data,
          borderColor: '#28a745',
          backgroundColor: 'rgba(40,167,69,0.1)',
          fill: true,
          tension: 0.3
        }]
      },
      options: commonOptions
    });

    const currentNode2Chart = new Chart(currentNode2Ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: '‡∏Å‡∏£‡∏∞‡πÅ‡∏™ Node 2 (mA)',
          data: currentNode2Data,
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220,53,69,0.1)',
          fill: true,
          tension: 0.3
        }]
      },
      options: commonOptions
    });

    async function loadData() {
      try {
        const url = `https://backend-water-rf88.onrender.com/distance?_=${Date.now()}`;
        const res = await fetch(url, { cache: 'no-store' });
        const data = await res.json();

        // ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';

        data.reverse().forEach(item => {
          const level = (fixedDepth - item.distance).toFixed(1);
          const distanceRaw = item.distance > 0 ? item.distance.toFixed(1) : '-';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${distanceRaw}</td>
            <td>${item.distance > 0 ? level : '-'}</td>
            <td>${item.rssi_node1 !== undefined ? item.rssi_node1 : '-'}</td>
            <td>${item.rssi_node2 !== undefined ? item.rssi_node2 : '-'}</td>
            <td>${item.v_node1 !== undefined ? item.v_node1 + ' V' : '-'}</td>
            <td>${item.i_node1 !== undefined ? item.i_node1 + ' mA' : '-'}</td>
            <td>${item.v_node2 !== undefined ? item.v_node2 + ' V' : '-'}</td>
            <td>${item.i_node2 !== undefined ? item.i_node2 + ' mA' : '-'}</td>
            <td>${item.time_node1 || '-'}</td>
            <td>${item.time_node2 || '-'}</td>
          `;
          tbody.appendChild(tr);
        });

        const latest = data[0];
        if (latest) {
          const level = (fixedDepth - latest.distance).toFixed(1);

          document.getElementById('waterLevelNode1').innerText =
            latest.distance > 0 ? `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: ${level} cm` : '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: -';

          document.getElementById('rssiNode1').innerText =
            latest.rssi_node1 !== undefined ? `RSSI: ${latest.rssi_node1}` : 'RSSI: -';

          document.getElementById('voltageNode1').innerText =
            latest.v_node1 !== undefined ? `‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: ${latest.v_node1} V` : '‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: -';

          document.getElementById('currentNode1').innerText =
            latest.i_node1 !== undefined ? `‡∏Å‡∏£‡∏∞‡πÅ‡∏™: ${latest.i_node1} mA` : '‡∏Å‡∏£‡∏∞‡πÅ‡∏™: -';

          document.getElementById('timeNode1').innerText =
            latest.time_node1 || '‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: -';

          document.getElementById('rssiNode2').innerText =
            latest.rssi_node2 !== undefined ? `RSSI: ${latest.rssi_node2}` : 'RSSI: -';

          document.getElementById('voltageNode2').innerText =
            latest.v_node2 !== undefined ? `‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: ${latest.v_node2} V` : '‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: -';

          document.getElementById('currentNode2').innerText =
            latest.i_node2 !== undefined ? `‡∏Å‡∏£‡∏∞‡πÅ‡∏™: ${latest.i_node2} mA` : '‡∏Å‡∏£‡∏∞‡πÅ‡∏™: -';

          document.getElementById('timeNode2').innerText =
            latest.time_node2 || '‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: -';

          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
          // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤
          const timeLabel = latest.time_node1 || new Date().toLocaleTimeString();
          if (labels.length === 0 || labels[labels.length-1] !== timeLabel) {
            labels.push(timeLabel);
            if (labels.length > 20) labels.shift();

            // ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥
            waterLevelData.push(level);
            if (waterLevelData.length > 20) waterLevelData.shift();

            // ‡∏Å‡∏£‡∏∞‡πÅ‡∏™ Node 1
            currentNode1Data.push(latest.i_node1 || 0);
            if (currentNode1Data.length > 20) currentNode1Data.shift();

            // ‡∏Å‡∏£‡∏∞‡πÅ‡∏™ Node 2
            currentNode2Data.push(latest.i_node2 || 0);
            if (currentNode2Data.length > 20) currentNode2Data.shift();

            // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Å‡∏£‡∏≤‡∏ü
            waterLevelChart.update();
            currentNode1Chart.update();
            currentNode2Chart.update();
          }
        }

      } catch (error) {
        console.error('Load data error:', error);
      }
    }

    loadData();
    setInterval(loadData, 5000);
  </script>
</body>
</html>
