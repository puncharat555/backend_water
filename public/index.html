<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Water Level Monitoring</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .table-wrapper {
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>
  <h1>Water Level Monitoring</h1>

  <!-- Node 1 -->
  <section>
    <h2>Node 1</h2>
    <h3 id="waterLevelNode1">ระดับน้ำ: - cm</h3>
    <h3 id="rssiNode1">RSSI: - dBm</h3>
    <h4 id="voltageNode1">แรงดัน: - V</h4>
    <h4 id="currentNode1">กระแส: - mA</h4>
    <h4 id="timeNode1">เวลาวัด: -</h4>
  </section>

  <!-- Node 2 -->
  <section>
    <h2>Node 2</h2>
    <h3 id="rssiNode2">RSSI: - dBm</h3>
    <h4 id="voltageNode2">แรงดัน: - V</h4>
    <h4 id="currentNode2">กระแส: - mA</h4>
    <h4 id="timeNode2">เวลาวัด: -</h4>
  </section>

  <!-- ตารางรวม -->
  <div class="table-wrapper">
    <h2>ข้อมูลทั้งหมด</h2>
    <table id="dataTable">
      <thead>
        <tr>
          <th>ระดับน้ำ (cm)</th>
          <th>RSSI Node 1</th>
          <th>RSSI Node 2</th>
          <th>V1</th>
          <th>I1</th>
          <th>V2</th>
          <th>I2</th>
          <th>Time Node 1</th>
          <th>Time Node 2</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const fixedDepth = 120;

    async function loadData() {
      try {
        const res = await fetch('https://backend-water-rf88.onrender.com/distance');
        const data = await res.json();

        const latest = data[data.length - 1]; // แถวล่าสุด
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';

        data.forEach(item => {
          const level = (fixedDepth - item.distance).toFixed(1);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${level}</td>
            <td>${item.rssi_node1 ?? '-'}</td>
            <td>${item.rssi_node2 ?? '-'}</td>
            <td>${item.v_node1 ?? '-'}</td>
            <td>${item.i_node1 ?? '-'}</td>
            <td>${item.v_node2 ?? '-'}</td>
            <td>${item.i_node2 ?? '-'}</td>
            <td>${item.time_node1 ?? '-'}</td>
            <td>${item.time_node2 ?? '-'}</td>
          `;
          tbody.appendChild(tr);
        });

        if (latest) {
          const level = (fixedDepth - latest.distance).toFixed(1);

          // Node 1
          document.getElementById('waterLevelNode1').innerText = `ระดับน้ำ: ${level} cm`;
          document.getElementById('rssiNode1').innerText = `RSSI: ${latest.rssi_node1 ?? '-'} dBm`;
          document.getElementById('voltageNode1').innerText = `แรงดัน: ${latest.v_node1 ?? '-'} V`;
          document.getElementById('currentNode1').innerText = `กระแส: ${latest.i_node1 ?? '-'} mA`;
          document.getElementById('timeNode1').innerText = `เวลาวัด: ${latest.time_node1 ?? '-'}`;

          // Node 2 (ไม่มีระดับน้ำ)
          document.getElementById('rssiNode2').innerText = `RSSI: ${latest.rssi_node2 ?? '-'} dBm`;
          document.getElementById('voltageNode2').innerText = `แรงดัน: ${latest.v_node2 ?? '-'} V`;
          document.getElementById('currentNode2').innerText = `กระแส: ${latest.i_node2 ?? '-'} mA`;
          document.getElementById('timeNode2').innerText = `เวลาวัด: ${latest.time_node2 ?? '-'}`;
        }

      } catch (error) {
        console.error('เกิดข้อผิดพลาด:', error);
        document.getElementById('waterLevelNode1').innerText = 'โหลดข้อมูลล้มเหลว';
        document.getElementById('rssiNode1').innerText = '';
        document.getElementById('rssiNode2').innerText = '';
      }
    }

    loadData();
    setInterval(loadData, 5000);
  </script>
</body>
</html>
