<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Water Level Monitoring</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="https://cdn.creazilla.com/emojis/58647/droplet-emoji-clipart-lg.png">

</head>
<body>
  <h1 class="title">Water Level Monitoring</h1>

  <div class="water-level-display">
    <div class="water-depth">
      <p id="waterLevelNode1" class="main-water-level">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: -</p>
    </div>
  </div>

  <div class="container">
    <!-- Node 1 -->
    <div class="node-box">
      <h2>Node 1</h2>
      <p id="rssiNode1">RSSI: -</p>
      <p id="voltageNode1">‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: -</p>
      <p id="currentNode1">‡∏Å‡∏£‡∏∞‡πÅ‡∏™: -</p>
      <p id="timeNode1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: -</p>
    </div>

    <!-- Node 2 -->
    <div class="node-box">
      <h2>Node 2</h2>
      <p id="rssiNode2">RSSI: -</p>
      <p id="voltageNode2">‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: -</p>
      <p id="currentNode2">‡∏Å‡∏£‡∏∞‡πÅ‡∏™: -</p>
      <p id="timeNode2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: -</p>
    </div>
  </div>

  <div class="charts-container">
    <div class="chart-box">
  <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</h3>
  <div id="timeRangeButtons" style="text-align:center; margin-bottom:15px;">
    <button class="range-btn active" data-range="1d">‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 1 ‡∏ß‡∏±‡∏ô</button>
    <button class="range-btn" data-range="7d">‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô</button>
    <button class="range-btn" data-range="30d">‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 30 ‡∏ß‡∏±‡∏ô</button>
  </div>
  <canvas id="waterLevelChart30d" height="300"></canvas>
</div>

    <div class="chart-box">
      <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</h3>
      <canvas id="waterLevelChart1h" height="300"></canvas>
    </div>
    <div class="chart-box">
      <h3>‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà Node 1 ‡πÅ‡∏•‡∏∞ Node 2</h3>
      <canvas id="batteryChart" height="300"></canvas>
    </div>
    <div class="chart-box">
  <h3>‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏£‡∏∞‡πÅ‡∏™ (Current mA)</h3>
  <div id="currentTimeRangeButtons" style="text-align:center; margin-bottom:10px;">
    <button class="range-btn active" data-range="1d">‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 1 ‡∏ß‡∏±‡∏ô</button>
    <button class="range-btn" data-range="7d">‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 7 ‡∏ß‡∏±‡∏ô</button>
    <button class="range-btn" data-range="30d">‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 30 ‡∏ß‡∏±‡∏ô</button>
  </div>
  <canvas id="currentChart" width="400" height="200"></canvas>
</div>

  </div>
  <div class="chart-box map-box">
  <h3>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h3>
  <div id="map" style="height: 300px; border:1px solid rgba(255,255,255,0.3); border-radius: 10px;"></div>
</div>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
/>
<script
  src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
></script>

<script>
  const map = L.map('map').setView([19.030471, 99.884592], 16);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution:
      '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
  }).addTo(map);

  const locations = [
    [19.030471, 99.884592],
    [19.028255, 99.892867],
    [19.026849, 99.900480],
  ];

  // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡πÄ‡∏ó‡∏≤
  const polyline = L.polyline(locations, {
    color: 'gray',
    weight: 5,
    opacity: 0.3,
  }).addTo(map);

  map.fitBounds(polyline.getBounds());

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ t (0-1)
  function interpolateLatLng(line, t) {
    const latlngs = line.getLatLngs();
    let totalLength = 0;
    let segmentLengths = [];

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÅ‡∏ï‡πà‡∏•‡∏∞ segment ‡πÅ‡∏•‡∏∞‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    for (let i = 0; i < latlngs.length - 1; i++) {
      const segmentLength = latlngs[i].distanceTo(latlngs[i + 1]);
      segmentLengths.push(segmentLength);
      totalLength += segmentLength;
    }

    let distanceAlong = t * totalLength;

    // ‡∏´‡∏≤ segment ‡∏ó‡∏µ‡πà t ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ô‡∏±‡πâ‡∏ô
    for (let i = 0; i < segmentLengths.length; i++) {
      if (distanceAlong <= segmentLengths[i]) {
        const segmentT = distanceAlong / segmentLengths[i];
        const lat = latlngs[i].lat + (latlngs[i + 1].lat - latlngs[i].lat) * segmentT;
        const lng = latlngs[i].lng + (latlngs[i + 1].lng - latlngs[i].lng) * segmentT;
        return L.latLng(lat, lng);
      } else {
        distanceAlong -= segmentLengths[i];
      }
    }

    return latlngs[latlngs.length - 1];
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏•‡πá‡∏Å ‡πÜ
  const movingDot = L.circleMarker(locations[0], {
    radius: 6,
    color: 'deepskyblue',
    fillColor: 'deepskyblue',
    fillOpacity: 1,
  }).addTo(map);

  let t = 0;
  const speed = 0.002; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏à‡∏∏‡∏î‡πÑ‡∏´‡∏• (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)

  function animate() {
    t += speed;
    if (t > 1) t = 0; // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

    const pos = interpolateLatLng(polyline, t);
    movingDot.setLatLng(pos);

    requestAnimationFrame(animate);
  }

  animate();
</script>



  <div class="table-wrapper">
    <h3>
      üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
      <span class="error-toggle" onclick="toggleErrorBox()" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥">‚ùó</span>
    </h3>
    
    <div id="errorBox" class="error-box hidden">
      <h4>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</h4>
      <ul id="errorList">
      </ul>
    </div>

    <table id="dataTable">
      <thead>
        <tr>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏î‡∏¥‡∏ö (cm)</th>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (cm)</th>
          <th>RSSI Node1</th>
          <th>RSSI Node2</th>
          <th>V Node1</th>
          <th>I Node1</th>
          <th>V Node2</th>
          <th>I Node2</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î Node1</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î Node2</th>
        </tr>
      </thead>
      <tbody></tbody>
      </table>
    <div id="moreButtonContainer" style="text-align: center; margin-top: 10px;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="script.js"></script>
</body>
</html>
