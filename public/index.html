<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Water Level Monitoring - กราฟแยก</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
</head>
<body>

  <h1 class="title">Water Level Monitoring</h1>

  <div class="graphs-container">

    <div class="graph-box" id="waterLevelBox">
      <h2>ระดับน้ำ (cm)</h2>
      <div class="chart-wrapper">
        <canvas id="waterLevelChart"></canvas>
      </div>
      <button class="btn-reset" onclick="resetZoom(waterLevelChart)">รีเซ็ต Zoom</button>
    </div>

    <div class="graph-box" id="currentNode1Box">
      <h2>กระแสไฟฟ้า Node 1 (mA)</h2>
      <div class="chart-wrapper">
        <canvas id="currentNode1Chart"></canvas>
      </div>
      <button class="btn-reset" onclick="resetZoom(currentNode1Chart)">รีเซ็ต Zoom</button>
    </div>

    <div class="graph-box" id="currentNode2Box">
      <h2>กระแสไฟฟ้า Node 2 (mA)</h2>
      <div class="chart-wrapper">
        <canvas id="currentNode2Chart"></canvas>
      </div>
      <button class="btn-reset" onclick="resetZoom(currentNode2Chart)">รีเซ็ต Zoom</button>
    </div>

  </div>

  <script>
    let waterLevelChart, currentNode1Chart, currentNode2Chart;
    const labels = [];
    const waterLevelData = [];
    const currentNode1Data = [];
    const currentNode2Data = [];

    const commonOptions = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true },
        zoom: {
          pan: { enabled: true, mode: 'x' },
          zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
        },
        tooltip: {
          mode: 'nearest',
          intersect: false,
          callbacks: {
            label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}`
          }
        }
      },
      scales: {
        x: {
          type: 'category',
          title: { display: true, text: 'เวลา (HH:MM:SS)' },
          ticks: { maxRotation: 45, minRotation: 45 }
        },
        y: {
          beginAtZero: true,
          title: { display: true, text: '' },
          grid: {
            drawBorder: false,
            color: 'rgba(0,0,0,0.1)'
          }
        }
      }
    };

    function createWaterLevelChart(ctx) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'ระดับน้ำ (cm)',
            data: waterLevelData,
            borderColor: '#007bff',
            backgroundColor: 'rgba(0,123,255,0.15)',
            fill: true,
            tension: 0.25,
            pointRadius: 4,
            pointHoverRadius: 6,
            borderWidth: 2,
            cubicInterpolationMode: 'monotone'
          }]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales,
            y: {
              ...commonOptions.scales.y,
              title: { display: true, text: 'ซม.' }
            }
          }
        }
      });
    }

    function createCurrentNode1Chart(ctx) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'กระแส Node 1 (mA)',
            data: currentNode1Data,
            borderColor: '#28a745',
            backgroundColor: 'rgba(40,167,69,0.15)',
            fill: true,
            tension: 0.25,
            pointRadius: 4,
            pointHoverRadius: 6,
            borderWidth: 2,
            cubicInterpolationMode: 'monotone'
          }]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales,
            y: {
              ...commonOptions.scales.y,
              title: { display: true, text: 'mA' }
            }
          }
        }
      });
    }

    function createCurrentNode2Chart(ctx) {
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'กระแส Node 2 (mA)',
            data: currentNode2Data,
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220,53,69,0.15)',
            fill: true,
            tension: 0.25,
            pointRadius: 4,
            pointHoverRadius: 6,
            borderWidth: 2,
            cubicInterpolationMode: 'monotone'
          }]
        },
        options: {
          ...commonOptions,
          scales: {
            ...commonOptions.scales,
            y: {
              ...commonOptions.scales.y,
              title: { display: true, text: 'mA' }
            }
          }
        }
      });
    }

    function resetZoom(chart) {
      chart.resetZoom();
    }

    window.onload = () => {
      waterLevelChart = createWaterLevelChart(document.getElementById('waterLevelChart').getContext('2d'));
      currentNode1Chart = createCurrentNode1Chart(document.getElementById('currentNode1Chart').getContext('2d'));
      currentNode2Chart = createCurrentNode2Chart(document.getElementById('currentNode2Chart').getContext('2d'));
      updateData();
      setInterval(updateData, 5000);
    };

    async function updateData() {
      try {
        const fixedDepth = 120;
        const url = `https://backend-water-rf88.onrender.com/distance?_=${Date.now()}`;
        const res = await fetch(url, {cache: 'no-store'});
        const data = await res.json();

        const latest = data[0];
        if (!latest) return;

        const timeLabel = latest.time_node1 || new Date().toLocaleTimeString();

        if (labels.length === 0 || labels[labels.length - 1] !== timeLabel) {
          labels.push(timeLabel);
          if (labels.length > 20) labels.shift();

          const level = latest.distance > 0 ? (fixedDepth - latest.distance).toFixed(1) : null;
          if(level !== null){
            waterLevelData.push(level);
            if (waterLevelData.length > 20) waterLevelData.shift();
          }

          const current1 = latest.i_node1 !== undefined ? latest.i_node1 : null;
          if(current1 !== null){
            currentNode1Data.push(current1);
            if(currentNode1Data.length > 20) currentNode1Data.shift();
          }

          const current2 = latest.i_node2 !== undefined ? latest.i_node2 : null;
          if(current2 !== null){
            currentNode2Data.push(current2);
            if(currentNode2Data.length > 20) currentNode2Data.shift();
          }

          waterLevelChart.update();
          currentNode1Chart.update();
          currentNode2Chart.update();
        }
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }
  </script>

</body>
</html>
