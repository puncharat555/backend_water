<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Water Level Monitoring</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .table-wrapper {
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>
  <h1>Water Level Monitoring</h1>

  <!-- Node 1 -->
  <section>
    <h2>Node 1 (ข้อมูลล่าสุด)</h2>
    <h3 id="waterLevelNode1">ระดับน้ำ: - cm</h3>
    <h4>วัดจากความลึกของแหล่งน้ำ: 120 cm</h4>
    <h3 id="rssiLevelNode1">RSSI: - dBm</h3>
  </section>

  <!-- Node 2 -->
  <section>
    <h2>Node 2 (ข้อมูลก่อนหน้า)</h2>
    <h3 id="waterLevelNode2">ระดับน้ำ: - cm</h3>
    <h4>วัดจากความลึกของแหล่งน้ำ: 120 cm</h4>
    <h3 id="rssiLevelNode2">RSSI: - dBm</h3>
  </section>

  <!-- ตารางรวม -->
  <div class="table-wrapper">
    <h2>ตารางข้อมูลทั้งหมด</h2>
    <table id="distanceTable">
      <thead>
        <tr>
          <th>ระยะห่างจากผิวน้ำ (cm)</th>
          <th>ระดับน้ำ (cm)</th>
          <th>RSSI (dBm)</th>
          <th>เวลาวัด</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const fixedDepth = 120;

    async function loadData() {
      try {
        const res = await fetch('https://backend-water-rf88.onrender.com/distance');
        const data = await res.json();

        const tbody = document.querySelector('#distanceTable tbody');
        tbody.innerHTML = '';

        // แสดงข้อมูลทั้งหมดในตาราง
        data.forEach(item => {
          const level = (fixedDepth - item.distance).toFixed(1);
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${item.distance}</td>
            <td>${item.distance > 0 ? level : '-'}</td>
            <td>${item.rssi ?? '-'}</td>
            <td>${new Date(item.timestamp).toLocaleString()}</td>
          `;
          tbody.appendChild(tr);
        });

        // Node 1 = แถวล่าสุด
        const node1 = data[data.length - 1];
        // Node 2 = แถวก่อนหน้า
        const node2 = data[data.length - 2];

        if (node1) {
          const level1 = (fixedDepth - node1.distance).toFixed(1);
          document.getElementById('waterLevelNode1').innerText =
            `ระดับน้ำ: ${node1.distance > 0 ? level1 + ' cm' : 'ไม่สามารถวัดได้'}`;
          document.getElementById('rssiLevelNode1').innerText =
            `RSSI: ${node1.rssi ?? '-'}`;
        }

        if (node2) {
          const level2 = (fixedDepth - node2.distance).toFixed(1);
          document.getElementById('waterLevelNode2').innerText =
            `ระดับน้ำ: ${node2.distance > 0 ? level2 + ' cm' : 'ไม่สามารถวัดได้'}`;
          document.getElementById('rssiLevelNode2').innerText =
            `RSSI: ${node2.rssi ?? '-'}`;
        }

      } catch (error) {
        document.getElementById('waterLevelNode1').innerText = 'โหลดข้อมูลล้มเหลว';
        document.getElementById('rssiLevelNode1').innerText = '';
        document.getElementById('waterLevelNode2').innerText = 'โหลดข้อมูลล้มเหลว';
        document.getElementById('rssiLevelNode2').innerText = '';
        console.error('Load data error:', error);
      }
    }

    loadData();
    setInterval(loadData, 5000);
  </script>
</body>
</html>
