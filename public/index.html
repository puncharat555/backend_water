<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>Water Level Monitoring</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1 class="title">Water Level Monitoring</h1>

  <div class="container">
    <!-- Node 1 -->
    <div class="node-box">
      <div class="water-level-display" id="waterLevelNode1">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: -</div>
      <h2>üì° Node 1</h2>
      <p id="rssiNode1">RSSI: -</p>
      <p id="voltageNode1">‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: -</p>
      <p id="currentNode1">‡∏Å‡∏£‡∏∞‡πÅ‡∏™: -</p>
      <p id="timeNode1">‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: -</p>
    </div>

    <!-- Node 2 -->
    <div class="node-box">
      <div class="water-level-display" id="waterLevelNode2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: -</div>
      <h2>üîÅ Node 2</h2>
      <p id="rssiNode2">RSSI: -</p>
      <p id="voltageNode2">‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: -</p>
      <p id="currentNode2">‡∏Å‡∏£‡∏∞‡πÅ‡∏™: -</p>
      <p id="timeNode2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: -</p>
    </div>
  </div>


  <div class="table-wrapper">
    <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
    <table id="dataTable">
      <thead>
        <tr>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥ (cm)</th>
          <th>RSSI Node1</th>
          <th>RSSI Node2</th>
          <th>V Node1</th>
          <th>I Node1</th>
          <th>V Node2</th>
          <th>I Node2</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î Node1</th>
          <th>‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î Node2</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
  const fixedDepth = 120;

  async function loadData() {
    try {
      const url = `https://backend-water-rf88.onrender.com/distance?_=${Date.now()}`;
      const res = await fetch(url, { cache: 'no-store' });
      const data = await res.json();

      console.log('Data from API:', data);

      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';

      data.forEach(item => {
        const level = (fixedDepth - item.distance).toFixed(1);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.distance > 0 ? level : '-'}</td>
          <td>${item.rssi_node1 !== undefined ? item.rssi_node1 : '-'}</td>
          <td>${item.rssi_node2 !== undefined ? item.rssi_node2 : '-'}</td>
          <td>${item.v_node1 !== undefined ? item.v_node1 : '-'}</td>
          <td>${item.i_node1 !== undefined ? item.i_node1 : '-'}</td>
          <td>${item.v_node2 !== undefined ? item.v_node2 : '-'}</td>
          <td>${item.i_node2 !== undefined ? item.i_node2 : '-'}</td>
          <td>${item.time_node1 || '-'}</td>
          <td>${item.time_node2 || '-'}</td>
        `;
        tbody.appendChild(tr);
      });

      const latest = data[0];
      if (latest) {
        const level = (fixedDepth - latest.distance).toFixed(1);

        document.getElementById('waterLevelNode1').innerText =
          latest.distance > 0 ? `‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: ${level} cm` : '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥: -';

        document.getElementById('rssiNode1').innerText =
          latest.rssi_node1 !== undefined ? `RSSI: ${latest.rssi_node1}` : 'RSSI: -';

        document.getElementById('voltageNode1').innerText =
          latest.v_node1 !== undefined ? `‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: ${latest.v_node1}` : '‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: -';

        document.getElementById('currentNode1').innerText =
          latest.i_node1 !== undefined ? `‡∏Å‡∏£‡∏∞‡πÅ‡∏™: ${latest.i_node1}` : '‡∏Å‡∏£‡∏∞‡πÅ‡∏™: -';

        document.getElementById('timeNode1').innerText =
          latest.time_node1 || '‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: -';

        document.getElementById('rssiNode2').innerText =
          latest.rssi_node2 !== undefined ? `RSSI: ${latest.rssi_node2}` : 'RSSI: -';

        document.getElementById('voltageNode2').innerText =
          latest.v_node2 !== undefined ? `‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: ${latest.v_node2}` : '‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô: -';

        document.getElementById('currentNode2').innerText =
          latest.i_node2 !== undefined ? `‡∏Å‡∏£‡∏∞‡πÅ‡∏™: ${latest.i_node2}` : '‡∏Å‡∏£‡∏∞‡πÅ‡∏™: -';

        document.getElementById('timeNode2').innerText =
          latest.time_node2 || '‡πÄ‡∏ß‡∏•‡∏≤‡∏ß‡∏±‡∏î: -';
      }

    } catch (error) {
      console.error('Load data error:', error);

      ['waterLevelNode1', 'rssiNode1', 'voltageNode1', 'currentNode1', 'timeNode1',
       'rssiNode2', 'voltageNode2', 'currentNode2', 'timeNode2'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerText = '-';
      });

      const waterLevelEl = document.getElementById('waterLevelNode1');
      if (waterLevelEl) waterLevelEl.innerText = '‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß';
    }
  }

  loadData();
  setInterval(loadData, 5000);
</script>

</body>
</html>
